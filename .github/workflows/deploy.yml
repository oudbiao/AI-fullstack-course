name: Auto Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 10m
          script: |
            set -e
            
            echo "========================================="
            echo "ğŸš€ å¼€å§‹éƒ¨ç½² AI Fullstack Course"
            echo "========================================="
            
            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd /opt/ai-course || mkdir -p /opt/ai-course && cd /opt/ai-course
            
            # åˆå§‹åŒ– git ä»“åº“ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            if [ ! -d .git ]; then
              git init
              git remote add origin https://github.com/oudbiao/AI-fullstack-course.git
            fi
            
            # 1. æ‹‰å–æœ€æ–°ä»£ç 
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
            git fetch origin main
            git reset --hard origin/main
            
            # 2. å…ˆæ„å»ºæ–°é•œåƒï¼ˆæ—§å®¹å™¨ç»§ç»­è¿è¡Œï¼ŒæœåŠ¡ä¿æŒå¯ç”¨ï¼‰
            echo "ğŸ§¹ æ¸…ç†æœ¬åœ°æ„å»ºäº§ç‰©..."
            rm -rf node_modules build
            echo "ğŸ”¨ æ„å»º Docker é•œåƒï¼ˆæ„å»ºæœŸé—´æ—§å®¹å™¨ä»åœ¨æœåŠ¡ï¼‰..."
            docker-compose build --no-cache
            
            # 3. æ„å»ºæˆåŠŸåå†åœæ—§å®¹å™¨ã€å¯æ–°å®¹å™¨ï¼ˆçŸ­æš‚åˆ‡æ¢ï¼‰
            echo "ğŸ›‘ åœæ­¢æ—§å®¹å™¨..."
            docker-compose down 2>/dev/null || true
            echo "â–¶ï¸  å¯åŠ¨æ–°å®¹å™¨..."
            docker-compose up -d
            
            # 4. ç­‰å¾…åº”ç”¨å°±ç»ªå¹¶å¥åº·æ£€æŸ¥
            echo "â³ ç­‰å¾…åº”ç”¨å¯åŠ¨..."
            for i in 1 2 3 4 5 6 7 8 9 10; do
              if docker-compose exec -T ai-course curl -sf http://localhost:3000/ >/dev/null 2>&1; then
                echo "âœ… åº”ç”¨å·²å°±ç»ªï¼ˆ${i}0s å†…ï¼‰"
                break
              fi
              if [ "$i" -eq 10 ]; then
                echo "âš ï¸  åº”ç”¨å¯åŠ¨è¶…æ—¶ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
                docker-compose logs --tail=50 ai-course
                exit 1
              fi
              sleep 10
            done
            
            # 5. æ£€æŸ¥å®¹å™¨çŠ¶æ€å¹¶æ¸…ç†æ‚¬ç©ºé•œåƒ
            echo "ğŸ“Š æ£€æŸ¥å®¹å™¨çŠ¶æ€..."
            docker-compose ps
            echo "ğŸ§¹ æ¸…ç†æ‚¬ç©ºé•œåƒ..."
            docker image prune -f
            
            echo ""
            echo "========================================="
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
            echo "========================================="
            echo "ğŸŒ è®¿é—®åœ°å€: https://your-domain.com"
            echo "ğŸ“Š å®¹å™¨çŠ¶æ€:"
            docker-compose ps
