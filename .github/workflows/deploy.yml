name: Auto Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 10m
          script: |
            set -e
            
            echo "========================================="
            echo "ğŸš€ å¼€å§‹éƒ¨ç½² AI Fullstack Course"
            echo "========================================="
            
            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd /opt/ai-course || mkdir -p /opt/ai-course && cd /opt/ai-course
            
            # åˆå§‹åŒ– git ä»“åº“ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            if [ ! -d .git ]; then
              git init
              git remote add origin https://github.com/oudbiao/AI-fullstack-course.git
            fi
            
            # 1. æ‹‰å–æœ€æ–°ä»£ç 
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
            git fetch origin main
            git reset --hard origin/main
            
            # 2. åœæ­¢æ—§å®¹å™¨
            echo "ğŸ›‘ åœæ­¢æ—§å®¹å™¨..."
            docker-compose down 2>/dev/null || true
            
            # 2.5. æ¸…ç†æ—§é•œåƒ
            echo "ğŸ§¹ æ¸…ç†æ—§é•œåƒ..."
            docker rmi ai-fullstack-course:latest 2>/dev/null || true
            
            # 3.1 æ¸…ç†ä¾èµ–å’Œæ„å»ºäº§ç‰©
            echo "ğŸ§¹ æ¸…ç†ä¾èµ–å’Œæ„å»ºäº§ç‰©..."
            rm -rf node_modules build

            # 3. æ„å»ºæ–°é•œåƒ
            echo "ğŸ”¨ æ„å»º Docker é•œåƒ..."
            docker-compose build --no-cache
            
            # 4. å¯åŠ¨æ–°å®¹å™¨
            echo "â–¶ï¸  å¯åŠ¨æ–°å®¹å™¨..."
            docker-compose up -d
            
            # 5. ç­‰å¾…åº”ç”¨å°±ç»ª
            echo "â³ ç­‰å¾…åº”ç”¨å¯åŠ¨..."
            sleep 10
            
            # 6. æ£€æŸ¥å®¹å™¨çŠ¶æ€
            echo "ğŸ“Š æ£€æŸ¥å®¹å™¨çŠ¶æ€..."
            docker-compose ps
            
            # 7. æ£€æŸ¥åº”ç”¨å¥åº·çŠ¶æ€
            HEALTH_CHECK=$(docker-compose exec -T ai-course curl -s http://localhost:3000/ || echo "failed")
            if [ "$HEALTH_CHECK" != "failed" ]; then
              echo "âœ… åº”ç”¨å“åº”æ­£å¸¸"
            else
              echo "âš ï¸  åº”ç”¨å“åº”ç¼“æ…¢ï¼Œä½†å®¹å™¨å·²å¯åŠ¨"
            fi
            
            # 8. æ¸…ç†æ—§é•œåƒ
            echo "ğŸ§¹ æ¸…ç†æ—§é•œåƒ..."
            docker image prune -f
            
            echo ""
            echo "========================================="
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
            echo "========================================="
            echo "ğŸŒ è®¿é—®åœ°å€: https://your-domain.com"
            echo "ğŸ“Š å®¹å™¨çŠ¶æ€:"
            docker-compose ps
